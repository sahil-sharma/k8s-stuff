global:
  enabled: true
  tlsDisable: false

injector:
  enabled: false

server:
  ha:
    enabled: false
    replicas: 1
    raft:
      enabled: true
      setNodeId: true

  config: |
    ui = true
    listener "tcp" {
      address = "0.0.0.0:8200"
      tls_disable = "true"
    }
    storage "raft" {
      path    = "/vault/data"
      node_id = "${HOSTNAME}" 
    }
    disable_mlock = true

  ingress:
    enabled: true
    ingressClassName: "nginx"
    pathType: Prefix
    hosts:
      - host: secrets.local.io
        paths:
          - /

  extraEnvironmentVars:
    VAULT_ADDR: http://vault.vault:8200
    VAULT_SKIP_VERIFY: true

  volumeMounts:
  - name: vault-init-volume
    mountPath: /v-data

  extraContainers:
    - name: vault-setup
      image: "hashicorp/vault:1.20.1"
      command: ["/bin/sh", "-c"]
      args:
        - |
          set -e
          echo -e "Sleeping to let Vault start up...\n"
          sleep 10 # Wait for Vault to be ready

          export VAULT_ADDR=http://vault.vault:8200
          export KEY_FILE="/vault/init-keys.txt"

          if vault status | grep -q 'Initialized.*false'; then
            echo "Vault not initialized. Starting to initialize Vault..."
            vault operator init -key-shares=1 -key-threshold=1 -format=json > $KEY_FILE
            echo "Vault initialization completed and keys saved to $KEY_FILE"

            echo "Fetching Unseal keys and root token..."
            UNSEAL_KEY=$(cat "$KEY_FILE" | grep '"unseal_keys_hex"' -A 1 | tail -n 1 | sed 's/[", ]//g')
            VAULT_TOKEN=$(cat "$KEY_FILE" | grep root_token | cut -d '"' -f4)           
            
            echo "Unsealing Vault..."
            vault operator unseal "$UNSEAL_KEY"
            
            echo "Logging-in Vault..."
            vault login "$VAULT_TOKEN"

            echo "Enabling KV mounts: apps, database, globals, sso"
            vault secrets enable -path=apps -version=2 kv
            vault secrets enable -path=database -version=2 kv
            vault secrets enable -path=globals -version=2 kv
            vault secrets enable -path=sso -version=2 kv

            echo "Storing the init JSON in the internal KV store for safekeeping..."
            vault kv put sso/vault/init root_token="$VAULT_TOKEN" keys_file="$(cat "$KEY_FILE")"

            echo "Creating example secrets"
            vault kv put apps/app1 config_username="usera" config_password="passa"
            vault kv put database/postgres creds_username="pguser" creds_password="pgpass"
            vault kv put globals/common api_key="globapikey123"

            echo "Writing policies (admin, reader, app, eso-read)"
            printf '%s\n' \
            'path "*" { capabilities = ["create","read","update","delete","list","sudo"] }' \
            > /tmp/admin.hcl
            vault policy write admin /tmp/admin.hcl

            printf '%s\n' \
            'path "apps/data/*" { capabilities = ["read","list"] }' \
            'path "apps/metadata/*" { capabilities = ["list"] }' \
            'path "globals/data/*" { capabilities = ["read","list"] }' \
            'path "globals/metadata/*" { capabilities = ["list"] }' \
            > /tmp/reader.hcl
            vault policy write reader /tmp/reader.hcl

            printf '%s\n' \
            'path "apps/data/*" { capabilities = ["read","list"] }' \
            'path "apps/metadata/*" { capabilities = ["list"] }' \
            'path "database/data/*" { capabilities = ["read","list"] }' \
            'path "database/metadata/*" { capabilities = ["list"] }' \
            'path "globals/data/*" { capabilities = ["read","list"] }' \
            'path "globals/metadata/*" { capabilities = ["list"] }' \
            > /tmp/app.hcl
            vault policy write app /tmp/app.hcl

            cp /tmp/app.hcl /tmp/eso-read.hcl
            vault policy write eso-read /tmp/eso-read.hcl

            printf '%s\n' \
            'path "auth/token/lookup-self" { capabilities = ["read"] }' \
            'path "auth/token/renew-self" { capabilities = ["update"] }' \
            'path "auth/token/revoke-self" { capabilities = ["update"] }' \
            'path "sys/capabilities-self" { capabilities = ["update"] }' \
            > /tmp/default.hcl
            vault policy write default-role /tmp/default.hcl

            echo "Enabling OIDC auth method..."
            vault auth enable -path=oidc oidc

            vault write auth/oidc/config \
              oidc_discovery_url="http://sso.local.io:32080/realms/platform" \
              oidc_client_id="vault" \
              oidc_client_secret="6qs4cs4L0eH68W4HeQs6Vl2we4VCVGQb" \
              default_role="default"

            vault write auth/oidc/role/admins \
              user_claim="preferred_username" \
              groups_claim="groups" \
              allowed_redirect_uris="$VAULT_ADDR/ui/vault/auth/oidc/oidc/callback" \
              allowed_redirect_uris="$VAULT_ADDR/oidc/oidc/callback" \
              allowed_redirect_uris="http://vault.vault:8200/ui/vault/auth/oidc/oidc/callback" \
              allowed_redirect_uris="http://vault.vault:8200/oidc/oidc/callback" \
              policies="admin" \
              ttl="1h" \
              bound_claims.groups='["devops"]'

            vault write auth/oidc/role/readers \
              user_claim="preferred_username" \
              groups_claim="groups" \
              allowed_redirect_uris="$VAULT_ADDR/ui/vault/auth/oidc/oidc/callback" \
              allowed_redirect_uris="$VAULT_ADDR/oidc/oidc/callback" \
              allowed_redirect_uris="http://vault.vault:8200/ui/vault/auth/oidc/oidc/callback" \
              allowed_redirect_uris="http://vault.vault:8200/oidc/oidc/callback" \
              policies="reader" \
              ttl="1h" \
              bound_claims.groups='["engineering"]'

            vault write auth/oidc/role/appusers \
              user_claim="preferred_username" \
              groups_claim="groups" \
              allowed_redirect_uris="$VAULT_ADDR/ui/vault/auth/oidc/oidc/callback" \
              allowed_redirect_uris="$VAULT_ADDR/oidc/oidc/callback" \
              allowed_redirect_uris="http://vault.vault:8200/ui/vault/auth/oidc/oidc/callback" \
              allowed_redirect_uris="http://vault.vault:8200/oidc/oidc/callback" \
              policies="app" \
              ttl="1h" \
              bound_claims.groups='["data"]'
  
            vault write auth/oidc/role/default \
              user_claim="preferred_username" \
              groups_claim="groups" \
              allowed_redirect_uris="$VAULT_ADDR/ui/vault/auth/oidc/oidc/callback" \
              allowed_redirect_uris="$VAULT_ADDR/oidc/oidc/callback" \
              allowed_redirect_uris="http://vault.vault:8200/ui/vault/auth/oidc/oidc/callback" \
              allowed_redirect_uris="http://vault.vault:8200/oidc/oidc/callback" \
              policies="default-role" \
              ttl="1h" \
              bound_claims.groups='["*"]'

            echo "Initscript executed successfully, idling..."
          else
            echo "Vault is already initialized. Skipping initialization."
          fi

          # Keep container running
          tail -f /dev/null

      volumeMounts:
        - name: vault-init-volume
          mountPath: /vault

  volumes:
    - name: vault-init-volume
      emptyDir: {}
      
  # volumes:
  #   - name: sso-ca
  #     secret:
  #       secretName: sso-ca-cert

  #   - name: vault-init-script
  #     configMap:
  #       name: vault-init-script
  #       defaultMode: 0777
  #       items:
  #         - key: "vault-init-script.sh"
  #           path: "vault-init-script.sh"
